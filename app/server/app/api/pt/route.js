"use strict";(()=>{var e={};e.id=3421,e.ids=[3421],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},35134:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>f,requestAsyncStorage:()=>g,routeModule:()=>x,serverHooks:()=>w,staticGenerationAsyncStorage:()=>T});var s={};r.r(s),r.d(s,{DELETE:()=>m,GET:()=>c,POST:()=>l,PUT:()=>d});var n=r(49303),a=r(88716),o=r(60670),i=r(87070),u=r(72331),p=r(60167);async function c(e){try{await (0,p.Ql)(e,"canViewPT");let t=await u._.pT.findMany({orderBy:{createdAt:"desc"},include:{receipts:!0}});return i.NextResponse.json(t)}catch(e){if(console.error("Error fetching PT sessions:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية عرض جلسات PT"},{status:403});return i.NextResponse.json({error:"فشل جلب جلسات PT"},{status:500})}}async function l(e){try{await (0,p.Ql)(e,"canCreatePT");let{ptNumber:t,clientName:r,phone:s,sessionsPurchased:n,coachName:a,pricePerSession:o,startDate:c,expiryDate:l,paymentMethod:d}=await e.json();if(console.log("\uD83D\uDCDD إضافة جلسة PT جديدة:",{ptNumber:t,clientName:r,sessionsPurchased:n}),!t)return i.NextResponse.json({error:"رقم PT مطلوب"},{status:400});if(await u._.pT.findUnique({where:{ptNumber:parseInt(t)}}))return console.error("❌ رقم PT مستخدم:",t),i.NextResponse.json({error:`رقم PT ${t} مستخدم بالفعل`},{status:400});if(c&&l){let e=new Date(c);if(new Date(l)<=e)return i.NextResponse.json({error:"تاريخ الانتهاء يجب أن يكون بعد تاريخ البداية"},{status:400})}let m=await u._.pT.create({data:{ptNumber:parseInt(t),clientName:r,phone:s,sessionsPurchased:n,sessionsRemaining:n,coachName:a,pricePerSession:o,startDate:c?new Date(c):null,expiryDate:l?new Date(l):null}});console.log("✅ تم إنشاء جلسة PT:",m.ptNumber);try{let e=await u._.receiptCounter.findUnique({where:{id:1}});e||(e=await u._.receiptCounter.create({data:{id:1,current:1e3}}));let t=n*o,i=null;if(c&&l){let e=new Date(c),t=new Date(l);i=Math.ceil((t.getTime()-e.getTime())/864e5)}let p=await u._.receipt.create({data:{receiptNumber:e.current,type:"اشتراك برايفت",amount:t,paymentMethod:d||"cash",itemDetails:JSON.stringify({ptNumber:m.ptNumber,clientName:r,sessionsPurchased:n,pricePerSession:o,totalAmount:t,coachName:a,startDate:c,expiryDate:l,subscriptionDays:i,phone:s})}});console.log("✅ تم إنشاء الإيصال:",p.receiptNumber),await u._.receiptCounter.update({where:{id:1},data:{current:e.current+1}})}catch(e){console.error("❌ خطأ في إنشاء الإيصال:",e)}return i.NextResponse.json(m,{status:201})}catch(e){if(console.error("❌ خطأ في إضافة جلسة PT:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية إضافة جلسات PT"},{status:403});return i.NextResponse.json({error:"فشل إضافة جلسة PT"},{status:500})}}async function d(e){try{await (0,p.Ql)(e,"canEditPT");let{ptNumber:t,action:r,...s}=await e.json();if("use_session"===r){let e=await u._.pT.findUnique({where:{ptNumber:parseInt(t)}});if(!e)return i.NextResponse.json({error:"جلسة PT غير موجودة"},{status:404});if(e.sessionsRemaining<=0)return i.NextResponse.json({error:"لا توجد جلسات متبقية"},{status:400});let r=await u._.pT.update({where:{ptNumber:parseInt(t)},data:{sessionsRemaining:e.sessionsRemaining-1}});return i.NextResponse.json(r)}{let e={...s};s.startDate&&(e.startDate=new Date(s.startDate)),s.expiryDate&&(e.expiryDate=new Date(s.expiryDate));let r=await u._.pT.update({where:{ptNumber:parseInt(t)},data:e});return i.NextResponse.json(r)}}catch(e){if(console.error("Error updating PT:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية تعديل جلسات PT"},{status:403});return i.NextResponse.json({error:"فشل تحديث جلسة PT"},{status:500})}}async function m(e){try{await (0,p.Ql)(e,"canDeletePT");let{searchParams:t}=new URL(e.url),r=t.get("ptNumber");if(!r)return i.NextResponse.json({error:"رقم PT مطلوب"},{status:400});return await u._.pT.delete({where:{ptNumber:parseInt(r)}}),i.NextResponse.json({message:"تم الحذف بنجاح"})}catch(e){if(console.error("Error deleting PT:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية حذف جلسات PT"},{status:403});return i.NextResponse.json({error:"فشل حذف جلسة PT"},{status:500})}}let x=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/pt/route",pathname:"/api/pt",filename:"route",bundlePath:"app/api/pt/route"},resolvedPagePath:"C:\\Users\\amran\\Desktop\\gym\\gym-management\\app\\api\\pt\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:T,serverHooks:w}=x,N="/api/pt/route";function f(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:T})}},72331:(e,t,r)=>{r.d(t,{_:()=>n});var s=r(53524);let n=globalThis.prisma??new s.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1482,167],()=>r(35134));module.exports=s})();
"use strict";(()=>{var e={};e.id=9179,e.ids=[9179],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78733:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>w,routeModule:()=>m,serverHooks:()=>x,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{DELETE:()=>c,GET:()=>d,POST:()=>p,PUT:()=>l});var o=r(49303),n=r(88716),i=r(60670),a=r(87070),u=r(72331);async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("search"),s=t.get("status"),o=t.get("fromDate"),n=t.get("toDate"),i={};r&&(i.OR=[{name:{contains:r,mode:"insensitive"}},{phone:{contains:r}}]),s&&"all"!==s&&(i.status=s),(o||n)&&(i.createdAt={},o&&(i.createdAt.gte=new Date(o)),n&&(i.createdAt.lte=new Date(n)));let d=await u._.visitor.findMany({where:i,orderBy:{createdAt:"desc"},include:{followUps:{orderBy:{createdAt:"desc"},take:1}}}),p=await u._.visitor.groupBy({by:["status"],_count:!0});return a.NextResponse.json({visitors:d,stats:p,total:d.length})}catch(e){return console.error("GET Error:",e),a.NextResponse.json({error:"فشل جلب الزوار"},{status:500})}}async function p(e){try{let{name:t,phone:r,notes:s,source:o,interestedIn:n}=await e.json();if(!t||!r)return a.NextResponse.json({error:"الاسم ورقم الهاتف مطلوبان"},{status:400});if(!/^(010|011|012|015)[0-9]{8}$/.test(r))return a.NextResponse.json({error:"رقم الهاتف غير صحيح. يجب أن يبدأ بـ 010, 011, 012, أو 015"},{status:400});let i=await u._.visitor.findUnique({where:{phone:r}});if(i)return a.NextResponse.json({error:"رقم الهاتف مسجل مسبقاً",existingVisitor:{id:i.id,name:i.name,status:i.status}},{status:409});let d=await u._.visitor.create({data:{name:t.trim(),phone:r.trim(),notes:s?.trim(),source:o||"walk-in",interestedIn:n?.trim(),status:"pending"}});return await u._.followUp.create({data:{visitorId:d.id,notes:"زيارة أولية - في انتظار التواصل",nextFollowUpDate:new Date(Date.now()+864e5)}}),a.NextResponse.json(d,{status:201})}catch(e){return console.error("POST Error:",e),a.NextResponse.json({error:"فشل إضافة الزائر"},{status:500})}}async function l(e){try{let{id:t,name:r,phone:s,notes:o,status:n,interestedIn:i,source:d}=await e.json();if(!t)return a.NextResponse.json({error:"معرف الزائر مطلوب"},{status:400});let p=await u._.visitor.findUnique({where:{id:t}});if(!p)return a.NextResponse.json({error:"الزائر غير موجود"},{status:404});if(s&&s!==p.phone){if(!/^(010|011|012|015)[0-9]{8}$/.test(s))return a.NextResponse.json({error:"رقم الهاتف غير صحيح"},{status:400});if(await u._.visitor.findUnique({where:{phone:s}}))return a.NextResponse.json({error:"رقم الهاتف مسجل لزائر آخر"},{status:409})}let l={};void 0!==r&&(l.name=r.trim()),void 0!==s&&(l.phone=s.trim()),void 0!==o&&(l.notes=o?.trim()),void 0!==n&&(l.status=n),void 0!==i&&(l.interestedIn=i?.trim()),void 0!==d&&(l.source=d);let c=await u._.visitor.update({where:{id:t},data:l});return a.NextResponse.json(c)}catch(e){return console.error("PUT Error:",e),a.NextResponse.json({error:"فشل التحديث"},{status:500})}}async function c(e){try{let{searchParams:t}=new URL(e.url),r=t.get("id");if(!r)return a.NextResponse.json({error:"معرف الزائر مطلوب"},{status:400});let s=await u._.visitor.findUnique({where:{id:r}});if(!s)return a.NextResponse.json({error:"الزائر غير موجود"},{status:404});return await u._.followUp.deleteMany({where:{visitorId:r}}),await u._.visitor.delete({where:{id:r}}),a.NextResponse.json({message:"تم الحذف بنجاح",deletedVisitor:{id:s.id,name:s.name}})}catch(e){return console.error("DELETE Error:",e),a.NextResponse.json({error:"فشل الحذف"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/visitors/route",pathname:"/api/visitors",filename:"route",bundlePath:"app/api/visitors/route"},resolvedPagePath:"C:\\Users\\amran\\Desktop\\gym\\gym-management\\app\\api\\visitors\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:x}=m,f="/api/visitors/route";function h(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:v})}},72331:(e,t,r)=>{r.d(t,{_:()=>o});var s=r(53524);let o=globalThis.prisma??new s.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>r(78733));module.exports=s})();
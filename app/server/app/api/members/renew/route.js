"use strict";(()=>{var e={};e.id=984,e.ids=[984],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},87750:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>f,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{POST:()=>c});var s=r(49303),i=r(88716),o=r(60670),a=r(87070),u=r(72331),m=r(60167);async function p(e){let t=e,r=0;for(;r<100;){if(!await u._.receipt.findUnique({where:{receiptNumber:t}}))return console.log(`✅ رقم إيصال متاح: ${t}`),t;console.log(`⚠️ رقم ${t} موجود، تجربة ${t+1}...`),t++,r++}throw Error(`فشل إيجاد رقم إيصال متاح بعد 100 محاولة`)}async function c(e){try{await (0,m.Ql)(e,"canEditMembers");let{memberId:t,subscriptionPrice:r,remainingAmount:n,freePTSessions:s,inBodyScans:i,invitations:o,startDate:c,expiryDate:l,notes:d,paymentMethod:g,staffName:x}=await e.json();if(console.log("\uD83D\uDD04 تجديد اشتراك عضو:",{memberId:t,subscriptionPrice:r,freePTSessions:s,inBodyScans:i,invitations:o,startDate:c,expiryDate:l,paymentMethod:g,staffName:x}),!x||!x.trim())return a.NextResponse.json({error:"اسم الموظف مطلوب"},{status:400});let w=await u._.member.findUnique({where:{id:t}});if(!w)return a.NextResponse.json({error:"العضو غير موجود"},{status:404});let f=w.freePTSessions||0,D=s||0,y=f+D,b=w.inBodyScans||0,h=i||0,v=b+h,N=w.invitations||0,S=o||0,q=N+S;console.log("\uD83D\uDCAA حصص PT: الحالية =",f,"+ الإضافية =",D,"= الإجمالي =",y),console.log("⚖️ InBody: الحالي =",b,"+ الإضافي =",h,"= الإجمالي =",v),console.log("\uD83C\uDF9F️ Invitations: الحالية =",N,"+ الإضافية =",S,"= الإجمالي =",q);let P=await u._.member.update({where:{id:t},data:{subscriptionPrice:r,remainingAmount:n||0,freePTSessions:y,inBodyScans:v,invitations:q,startDate:c?new Date(c):null,expiryDate:l?new Date(l):null,isActive:!0,notes:d||w.notes}});console.log("✅ تم تحديث بيانات العضو - PT:",P.freePTSessions,"InBody:",P.inBodyScans,"Invitations:",P.invitations);try{let e=await u._.receiptCounter.findUnique({where:{id:1}});e||(e=await u._.receiptCounter.create({data:{id:1,current:1e3}})),console.log("\uD83E\uDDFE رقم الإيصال من العداد:",e.current);let t=await p(e.current);console.log("✅ سيتم استخدام رقم الإيصال:",t);let s=r-(n||0),i=null;if(c&&l){let e=new Date(c),t=new Date(l);i=Math.ceil((t.getTime()-e.getTime())/864e5)}let o=await u._.receipt.create({data:{receiptNumber:t,type:"تجديد عضويه",amount:s,paymentMethod:g||"cash",staffName:x.trim(),itemDetails:JSON.stringify({memberNumber:w.memberNumber,memberName:w.name,subscriptionPrice:r,paidAmount:s,remainingAmount:n||0,freePTSessions:D,previousFreePTSessions:f,totalFreePTSessions:y,inBodyScans:h,previousInBodyScans:b,totalInBodyScans:v,invitations:S,previousInvitations:N,totalInvitations:q,previousExpiryDate:w.expiryDate,newStartDate:c,newExpiryDate:l,subscriptionDays:i,isRenewal:!0,staffName:x.trim()}),memberId:w.id}});console.log("✅ تم إنشاء إيصال التجديد:",o.receiptNumber);let m=t+1;return await u._.receiptCounter.update({where:{id:1},data:{current:m}}),console.log("\uD83D\uDD04 تم تحديث عداد الإيصالات إلى:",m),a.NextResponse.json({member:P,receipt:{receiptNumber:o.receiptNumber,amount:o.amount,paymentMethod:o.paymentMethod,staffName:o.staffName,itemDetails:JSON.parse(o.itemDetails),createdAt:o.createdAt}},{status:200})}catch(e){return console.error("❌ خطأ في إنشاء إيصال التجديد:",e),a.NextResponse.json({member:P,receipt:null,warning:"تم التجديد لكن فشل إنشاء الإيصال"},{status:200})}}catch(e){if(console.error("❌ خطأ في تجديد الاشتراك:",e),"Unauthorized"===e.message)return a.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return a.NextResponse.json({error:"ليس لديك صلاحية تجديد الاشتراكات"},{status:403});return a.NextResponse.json({error:"فشل تجديد الاشتراك"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/members/renew/route",pathname:"/api/members/renew",filename:"route",bundlePath:"app/api/members/renew/route"},resolvedPagePath:"C:\\Users\\amran\\Desktop\\gym\\gym-management\\app\\api\\members\\renew\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:g,serverHooks:x}=l,w="/api/members/renew/route";function f(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},72331:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,1482,167],()=>r(87750));module.exports=n})();
"use strict";(()=>{var e={};e.id=2106,e.ids=[2106],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},13454:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>b,routeModule:()=>l,serverHooks:()=>x,staticGenerationAsyncStorage:()=>d});var n={};t.r(n),t.d(n,{GET:()=>c,POST:()=>p});var s=t(49303),o=t(88716),a=t(60670),u=t(87070),i=t(72331),m=t(60167);async function c(e){try{await (0,m.Ql)(e,"canViewMembers"),console.log("\uD83D\uDD0D قراءة رقم العضوية التالي...");let r=await i._.memberCounter.findUnique({where:{id:1}});r||(console.log("\uD83D\uDCCA إنشاء MemberCounter لأول مرة"),r=await i._.memberCounter.create({data:{id:1,current:1001}})),console.log("\uD83D\uDCCA الرقم الحالي من Counter:",r.current);let t=r.current,n=0;for(;n<100;){if(!await i._.member.findUnique({where:{memberNumber:t}})){console.log(`✅ رقم متاح: ${t}`);break}console.log(`⚠️ رقم ${t} موجود، تجربة ${t+1}...`),t++,n++}if(n>=100)throw Error("فشل إيجاد رقم عضوية متاح");return u.NextResponse.json({nextNumber:t,message:"تم جلب رقم العضوية التالي بنجاح",fromCounter:!0},{status:200})}catch(e){if(console.error("❌ Error fetching next member number:",e),"Unauthorized"===e.message)return u.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return u.NextResponse.json({error:"ليس لديك صلاحية الوصول لأرقام العضوية"},{status:403});try{let e=await i._.member.findMany({where:{memberNumber:{not:null}},orderBy:{memberNumber:"desc"},select:{memberNumber:!0},take:1});if(e[0]&&e[0].memberNumber){let r=parseInt(e[0].memberNumber.toString())+1;return u.NextResponse.json({nextNumber:r,message:"تم جلب الرقم من آخر عضو",fromCounter:!1},{status:200})}}catch(e){console.error("❌ Fallback failed:",e)}return u.NextResponse.json({nextNumber:1001,message:"تم استخدام رقم افتراضي",fromCounter:!1,error:e instanceof Error?e.message:"Unknown error"},{status:200})}}async function p(e){try{await (0,m.Ql)(e,"canAccessSettings");let{startNumber:r}=await e.json();if(!r||r<1)return u.NextResponse.json({error:"رقم البداية غير صحيح"},{status:400});let t=parseInt(r);if(await i._.member.findUnique({where:{memberNumber:t}}))return u.NextResponse.json({error:`رقم العضوية ${t} مستخدم بالفعل. اختر رقماً أكبر.`},{status:400});return await i._.memberCounter.upsert({where:{id:1},update:{current:t},create:{id:1,current:t}}),console.log("✅ تم تحديث MemberCounter إلى:",t),u.NextResponse.json({success:!0,newNumber:t,message:`تم تحديث رقم العضوية ليبدأ من ${t}`})}catch(e){if(console.error("❌ Error updating member counter:",e),"Unauthorized"===e.message)return u.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return u.NextResponse.json({error:"ليس لديك صلاحية تعديل إعدادات العضوية"},{status:403});return u.NextResponse.json({error:"فشل تحديث رقم العضوية",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/members/next-number/route",pathname:"/api/members/next-number",filename:"route",bundlePath:"app/api/members/next-number/route"},resolvedPagePath:"C:\\Users\\amran\\Desktop\\gym\\gym-management\\app\\api\\members\\next-number\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:b,staticGenerationAsyncStorage:d,serverHooks:x}=l,g="/api/members/next-number/route";function f(){return(0,a.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:d})}},72331:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[8948,5972,1482,167],()=>t(13454));module.exports=n})();
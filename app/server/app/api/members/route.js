"use strict";(()=>{var e={};e.id=5738,e.ids=[5738],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},97270:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>b,serverHooks:()=>x,staticGenerationAsyncStorage:()=>D});var n={};t.r(n),t.d(n,{DELETE:()=>g,GET:()=>l,POST:()=>p,PUT:()=>d});var s=t(49303),o=t(88716),a=t(60670),i=t(87070),u=t(72331),m=t(60167);async function c(e){let r=parseInt(e.toString()),t=0;for(;t<100;){if(!await u._.receipt.findUnique({where:{receiptNumber:r}}))return console.log(`✅ رقم إيصال متاح: ${r}`),r;console.log(`⚠️ رقم ${r} موجود، تجربة ${r+1}...`),r++,t++}throw Error(`فشل إيجاد رقم إيصال متاح بعد 100 محاولة`)}async function l(e){try{await (0,m.Ql)(e,"canViewMembers"),console.log("\uD83D\uDD0D بدء جلب الأعضاء...");let r=await u._.member.findMany({orderBy:{createdAt:"desc"},include:{receipts:!0}});if(console.log("✅ تم جلب",r.length,"عضو"),!Array.isArray(r))return console.error("❌ Prisma لم يرجع array:",typeof r),i.NextResponse.json([],{status:200});return i.NextResponse.json(r,{status:200})}catch(e){if(console.error("❌ Error fetching members:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية عرض الأعضاء"},{status:403});return i.NextResponse.json([],{status:200,headers:{"X-Error":"Failed to fetch members"}})}}async function p(e){try{await (0,m.Ql)(e,"canCreateMembers");let{memberNumber:r,name:t,phone:n,profileImage:s,inBodyScans:o,invitations:a,freePTSessions:l,subscriptionPrice:p,remainingAmount:d,notes:g,startDate:b,expiryDate:f,paymentMethod:D,staffName:x,isOther:h}=await e.json();if(console.log("\uD83D\uDCDD إضافة عضو جديد:",{memberNumber:r,name:t,profileImage:s,isOther:h,staffName:x}),!x||!x.trim())return i.NextResponse.json({error:"اسم الموظف مطلوب"},{status:400});let w=null;if(!0===h)w=null,console.log("✅ عضو Other (بدون رقم عضوية)");else{if(!r)return i.NextResponse.json({error:"رقم العضوية مطلوب"},{status:400});w=parseInt(r.toString()),console.log("✅ عضو عادي برقم:",w)}let N=parseInt((o||0).toString()),y=parseInt((a||0).toString()),j=parseInt((l||0).toString()),S=parseInt(p.toString()),R=parseInt((d||0).toString());if(null!==w&&await u._.member.findUnique({where:{memberNumber:w}}))return console.error("❌ رقم العضوية مستخدم:",w),i.NextResponse.json({error:`رقم العضوية ${w} مستخدم بالفعل`},{status:400});if(b&&f){let e=new Date(b);if(new Date(f)<=e)return i.NextResponse.json({error:"تاريخ الانتهاء يجب أن يكون بعد تاريخ البداية"},{status:400})}let v=await u._.member.create({data:{memberNumber:w,name:t,phone:n,profileImage:s,inBodyScans:N,invitations:y,freePTSessions:j,subscriptionPrice:S,remainingAmount:R,notes:g,startDate:b?new Date(b):null,expiryDate:f?new Date(f):null}});if(console.log("✅ تم إنشاء العضو:",v.id,"رقم العضوية:",v.memberNumber),null!==w)try{let e=await u._.memberCounter.findUnique({where:{id:1}});e?w>=e.current?(await u._.memberCounter.update({where:{id:1},data:{current:w+1}}),console.log("\uD83D\uDD04 تم تحديث MemberCounter إلى:",w+1)):console.log("ℹ️ المحتوى الحالي للـ Counter أعلى، لا داعي للتحديث"):(await u._.memberCounter.create({data:{id:1,current:w+1}}),console.log("\uD83D\uDCCA تم إنشاء MemberCounter بقيمة:",w+1))}catch(e){console.error("⚠️ خطأ في تحديث MemberCounter (غير حرج):",e)}let C=null;try{let e=await u._.receiptCounter.findUnique({where:{id:1}});e||(console.log("\uD83D\uDCCA إنشاء عداد الإيصالات لأول مرة"),e=await u._.receiptCounter.create({data:{id:1,current:1e3}})),console.log("\uD83E\uDDFE رقم الإيصال من العداد:",e.current);let r=await c(e.current);console.log("✅ سيتم استخدام رقم الإيصال:",r);let n=S-R,s=null;if(b&&f){let e=new Date(b),r=new Date(f);s=Math.ceil((r.getTime()-e.getTime())/864e5)}let o=await u._.receipt.create({data:{receiptNumber:r,type:"Member",amount:n,paymentMethod:D||"cash",staffName:x.trim(),itemDetails:JSON.stringify({memberNumber:w,memberName:t,subscriptionPrice:S,paidAmount:n,remainingAmount:R,freePTSessions:j,inBodyScans:N,invitations:y,startDate:b,expiryDate:f,subscriptionDays:s,staffName:x.trim(),isOther:!0===h}),memberId:v.id}});console.log("✅ تم إنشاء الإيصال:",o.receiptNumber);let a=r+1;await u._.receiptCounter.update({where:{id:1},data:{current:a}}),console.log("\uD83D\uDD04 تم تحديث عداد الإيصالات إلى:",a),C={receiptNumber:o.receiptNumber,amount:o.amount,paymentMethod:o.paymentMethod,staffName:o.staffName,createdAt:o.createdAt,itemDetails:JSON.parse(o.itemDetails)}}catch(e){console.error("❌ خطأ في إنشاء الإيصال:",e),e instanceof Error&&e.message.includes("Unique constraint")&&console.error("❌ رقم الإيصال مكرر! المحاولة مرة أخرى...")}return i.NextResponse.json({success:!0,member:v,receipt:C},{status:201})}catch(e){if(console.error("❌ خطأ في إضافة العضو:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية إضافة أعضاء"},{status:403});return i.NextResponse.json({error:"فشل إضافة العضو"},{status:500})}}async function d(e){try{await (0,m.Ql)(e,"canEditMembers");let{id:r,profileImage:t,...n}=await e.json(),s={};void 0!==n.memberNumber&&(s.memberNumber=n.memberNumber?parseInt(n.memberNumber.toString()):null),void 0!==n.inBodyScans&&(s.inBodyScans=parseInt(n.inBodyScans.toString())),void 0!==n.invitations&&(s.invitations=parseInt(n.invitations.toString())),void 0!==n.freePTSessions&&(s.freePTSessions=parseInt(n.freePTSessions.toString())),void 0!==n.subscriptionPrice&&(s.subscriptionPrice=parseInt(n.subscriptionPrice.toString())),void 0!==n.remainingAmount&&(s.remainingAmount=parseInt(n.remainingAmount.toString())),void 0!==t&&(s.profileImage=t),n.name&&(s.name=n.name),n.phone&&(s.phone=n.phone),void 0!==n.notes&&(s.notes=n.notes),n.startDate&&(s.startDate=new Date(n.startDate)),n.expiryDate&&(s.expiryDate=new Date(n.expiryDate));let o=await u._.member.update({where:{id:r},data:s});return i.NextResponse.json(o)}catch(e){if(console.error("Error updating member:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية تعديل الأعضاء"},{status:403});return i.NextResponse.json({error:"فشل تحديث العضو"},{status:500})}}async function g(e){try{await (0,m.Ql)(e,"canDeleteMembers");let{searchParams:r}=new URL(e.url),t=r.get("id");if(!t)return i.NextResponse.json({error:"رقم العضو مطلوب"},{status:400});return await u._.member.delete({where:{id:t}}),i.NextResponse.json({message:"تم الحذف بنجاح"})}catch(e){if(console.error("Error deleting member:",e),"Unauthorized"===e.message)return i.NextResponse.json({error:"يجب تسجيل الدخول أولاً"},{status:401});if(e.message.includes("Forbidden"))return i.NextResponse.json({error:"ليس لديك صلاحية حذف الأعضاء"},{status:403});return i.NextResponse.json({error:"فشل حذف العضو"},{status:500})}}let b=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/members/route",pathname:"/api/members",filename:"route",bundlePath:"app/api/members/route"},resolvedPagePath:"C:\\Users\\amran\\Desktop\\gym\\gym-management\\app\\api\\members\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:D,serverHooks:x}=b,h="/api/members/route";function w(){return(0,a.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:D})}},72331:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[8948,5972,1482,167],()=>t(97270));module.exports=n})();